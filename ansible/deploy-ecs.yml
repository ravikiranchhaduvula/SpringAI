--- 
- name: Deploy app to ECS
  hosts: local
  gather_facts: false
  vars:
    ansible_python_interpreter: /opt/ansible/bin/python3
  collections:
    - community.aws           # works with ansible-core 2.15 + collections <9
    - amazon.aws

  vars:
    aws_region: ap-southeast-2
    cluster_name: myapp-cluster
    service_name: myapp-web-svc
    taskdef_family: myapp-web

  tasks:
    - name: Register new ECS task definition revision
      community.aws.ecs_taskdefinition:
        family: "{{ taskdef_family }}"
        state: present
        launch_type: FARGATE
        network_mode: awsvpc
        cpu: "256"
        memory: "512"
        execution_role_arn: "arn:aws:iam::{{ lookup('aws_account_attribute','account_id') }}:role/ecsTaskExecutionRole"
        task_role_arn: "arn:aws:iam::{{ lookup('aws_account_attribute','account_id') }}:role/myappTaskRole"
        containers:
          - name: myapp-web
            image: "{{ image_uri }}"
            essential: true
            portMappings:
              - containerPort: 80          # change to 8080 if your app listens on 8080
                protocol: tcp
            logConfiguration:
              logDriver: awslogs
              options:
                awslogs-group: "/ecs/myapp-web"
                awslogs-region: "{{ aws_region }}"
                awslogs-stream-prefix: "ecs"
      register: td

    # Different collection versions return slightly different keys; normalize
    - name: Derive new task definition ARN
      set_fact:
        new_td_arn: >-
          {{ td.taskdefinition.taskDefinition.taskDefinitionArn
             | default(td.task_definition.task_definition_arn)
             | default(td.taskdefinition.task_definition_arn) }}

    - name: Update ECS service to use new task definition
      community.aws.ecs_service:
        state: present
        name: "{{ service_name }}"
        cluster: "{{ cluster_name }}"
        task_definition: "{{ new_td_arn }}"
        desired_count: 1
        force_new_deployment: true
